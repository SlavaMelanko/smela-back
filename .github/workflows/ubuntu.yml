name: CI

on:
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.json'
      - '**.yml'
      - '!.github/workflows/ubuntu.yml'
      - '**.yaml'
      - 'LICENSE'
      - '.gitignore'
  push:
    branches: [main, dev]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.json'
      - '**.yml'
      - '!.github/workflows/ubuntu.yml'
      - '**.yaml'
      - 'LICENSE'
      - '.gitignore'

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    container: oven/bun:latest
    environment: test

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          POSTGRES_INITDB_ARGS: --encoding=UTF-8 --lc-collate=C --lc-ctype=C
          TZ: UTC
        options: >-
          --health-cmd "pg_isready -U ${{ vars.POSTGRES_USER }} -d ${{ vars.POSTGRES_DB }}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    env:
      LOG_LEVEL: ${{ vars.LOG_LEVEL }}
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      COOKIE_NAME: ${{ vars.COOKIE_NAME }}
      COOKIE_DOMAIN: ${{ vars.COOKIE_DOMAIN }}
      BE_BASE_URL: ${{ vars.BE_BASE_URL }}
      FE_BASE_URL: ${{ vars.FE_BASE_URL }}
      EMAIL_SENDER_PROFILES: ${{ vars.EMAIL_SENDER_PROFILES }}
      EMAIL_ETHEREAL_HOST: ${{ vars.EMAIL_ETHEREAL_HOST }}
      EMAIL_ETHEREAL_PORT: ${{ vars.EMAIL_ETHEREAL_PORT }}
      EMAIL_ETHEREAL_USERNAME: ${{ vars.EMAIL_ETHEREAL_USERNAME }}
      EMAIL_ETHEREAL_PASSWORD: ${{ secrets.EMAIL_ETHEREAL_PASSWORD }}
      COMPANY_NAME: ${{ vars.COMPANY_NAME }}
      COMPANY_SOCIAL_LINKS: ${{ vars.COMPANY_SOCIAL_LINKS }}
      CAPTCHA_SECRET_KEY: ${{ secrets.CAPTCHA_SECRET_KEY }}

    steps:
      - name: Install dependencies for Codecov
        run: apt-get update && apt-get install -y git curl gpg

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: bun install

      - name: Wait for PostgreSQL
        run: |
          for i in {1..10}; do
            pg_isready -h postgres -U ${{ vars.POSTGRES_USER }} && break
            echo "Waiting for PostgreSQL... ($i/10)"
            sleep 1
          done

      - name: Run database migrations
        run: bun run db:generate && bun run db:migrate

      - name: Run linting
        run: bun run lint

      - name: Run all tests
        run: bun run test:all

      - name: Run tests with coverage
        run: bun run coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

  # build:
  #   runs-on: ubuntu-latest
  #   container: oven/bun:latest
  #   needs: tests

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Install dependencies
  #       run: bun install

  #     - name: Build project
  #       run: bun run build
