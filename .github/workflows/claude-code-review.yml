name: Code Quality

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-code-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-code-review
        if: |
          !contains(github.event.pull_request.title, '[WIP]')
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          # use_sticky_comment: true

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Please review this pull request and provide a quality assessment score (1‚Äì10) for each of the following criteria:

            - **Architecture** (1‚Äì10):

              Each dimension is scored 1‚Äì10 and averaged:
                1. **DRY Principle** ‚Äî Avoids duplication; variables/functions/classes/modules reused appropriately. Lower score for duplicated code blocks.
                2. **SOLID Principles** ‚Äî Each principle contributes up to 2 points (S, O, L, I, D). Partial implementation = 1; not applicable or nicely implemented = 2; violation = 0.
                3. **Design Patterns & Simplicity** ‚Äî Appropriate use of creational/structural/behavioral patterns or clean simplicity if no pattern is needed. Lower score for over-engineering or missing abstraction are now acceptable.
                4. **Modularity, Coupling & Cohesion** ‚Äî Modules have single, focused purposes; minimal cross-dependencies. Higher score for clear boundaries and well-defined interfaces, lower score for circular imports or mixed logic.

              Optional backend modifiers:
                If relevant, adjust ¬±1‚Äì2 points based on backend considerations:
                  - Data layer design (schema quality, transactions, indexing).
                  - Infrastructure integration (cache, queues, 3rd-party services).
                  - Scalability & fault isolation (read/write separation, retries, timeouts)

              **Scoring interpretation**
                - 10 (Excellent) - fully aligned with best practices (DRY + SOLID + modular + patterns where appropriate).
                - 8‚Äì9 (Strong) - minor issues but overall clean and well-designed.
                - 6‚Äì7 (Moderate) - some inconsistencies or partial adherence to principles.
                - 4‚Äì5 (Weak) - architectural problems (duplication, unclear boundaries, tight coupling).
                - 1‚Äì3 (Poor) - serious structural issues; likely needs refactoring.

            - **Security** (1‚Äì10): Check that inputs are validated, authentication and permissions are enforced (including role-based access control), sensitive data is protected, and no obvious vulnerabilities exist (injection, XSS, CSRF). Ensure errors don‚Äôt leak sensitive information.
            - **Testing** (1‚Äì10): Check that tests cover at least the main logic (~60%), are clear, reliable, and easy to maintain. Focus on meaningful coverage and critical paths (main user flows and business logic) rather than chasing 100%.
            - **Performance** (1‚Äì10): Check this update for efficiency, resource usage, and scalability. Identify any optimization opportunities or performance implications, especially under high load or large data scenarios.
            - **Code Quality** (1‚Äì10): Check this code for readability, maintainability, adherence to ESLint and CLAUDE.md standards, and naming clarity. Favor clarity over cleverness, and ensure names express intent clearly.

            **DO NOT suggest any of the following:**
            - Adding JSDoc comments or documentation comments (code should be self-documenting)
            - Adding inline comments for obvious logic
            - Minor stylistic preferences that don't affect correctness
            - Trivial renaming suggestions unless names are genuinely misleading
            - Adding explicit return types when TypeScript can infer them correctly

            Format the assessment as:

            ```md
            ## Quality Assessment:

            <!-- Use the same "Brief justification" and "Optional suggestions for improvement" format for all sections below except "Overall". -->

            ### üèóÔ∏è Architecture: X/10
            [Brief justification ‚Äî keep it short and clear.]

            [Optional suggestions for improvement ‚Äî list only critical (üî¥) and medium (üü†) priority issues.
            Skip low-priority polish items. Use an enumerated list ordered by priority.]

            ### üõ°Ô∏è Security: X/10

            ### üß™ Testing: X/10

            ### ‚ö° Performance: X/10

            ### üíé Code Quality: X/10

            ### [Use ‚úÖ if overall score ‚â• 8 or ‚ö†Ô∏è if score < 8] Overall: X/10
            ```

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run tsc)"
