name: Code Quality

on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - '**.md'
      - '**.yml'
      - '**.yaml'
      - '**.txt'
      - '**.json'
      - 'LICENSE'
      - '.gitignore'

jobs:
  claude-code-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-code-review
        if: |
          !contains(github.event.pull_request.title, '[WIP]')
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          # use_sticky_comment: true

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Please review this pull request and provide a quality assessment score (1-10) for each of these criteria:

            - **Architecture** (1-10): Check system design for modularity (loose coupling between modules and high cohesion within each module), clear separation of concerns, and proper abstractions (hide implementation details and export only necessary interfaces). Ensure each component aligns with SOLID best practices ‚Äî especially the Single Responsibility Principle
            - **Security** (1-10): Check that inputs are validated, auth & permissions are enforced (including role-based access control), sensitive data is protected, and no obvious vulnerabilities (injection, XSS, CSRF) exist. Errors don't leak sensitive information
            - **Testing** (1-10): Check that tests cover at least the main logic (~60%), are clear, reliable, and easy to maintain. Focus on meaningful coverage and critical paths (main user flows and business logic) rather than chasing 100%
            - **Performance** (1-10): Check this update for efficiency, resource usage, and scalability. Identify any optimization opportunities or performance implications, especially under high load or large data scenarios
            - **Code Quality** (1-10): Check this code for readability, maintainability, adherence to ESLint and CLAUDE.md standards, and naming clarity. Favor clarity over cleverness and ensure names express intent clearly

            Format the assessment as:
            ```md
            ## Quality Assessment:

            ### **Architecture üèóÔ∏è**: X/10
            [Brief justification]

            ### **Security üõ°Ô∏è**: X/10
            [Brief justification]

            ### **Testing üß™**: X/10
            [Brief justification]

            ### **Performance ‚ö°**: X/10
            [Brief justification]

            ### **Code Quality üíé**: X/10
            [Brief justification]

            ### **üåü Overall**: X/10 (average)

            ### üö¶ Recommendation:

            ‚úÖ Approve (if score 8.5+ overall)
            üí¨ Approve with suggestions (if score 7-7.4 overall)
            ‚ùå Request changes (if score <7 overall)

            ### Required Actions (if changes requested):
            - [ ] Implement changes based on review feedback
            - [ ] Add tests to cover missing scenarios
            - [ ] Improve documentation as needed
            - [ ] etc.
            ```

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"
